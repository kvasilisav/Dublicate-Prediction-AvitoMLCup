# Поиск дублей|Avito ML cup 2025

## Задача соревнования

Задача — разработать алгоритм, который на основе текстовой информации, изображений и других атрибутов позволит выявлять дубли в массиве объявлений.

## Pipeline решения

### Первичная обработка данных

#### Препроцессинг .parquet файлов

- Перевод названий брендов на один язык в title и description
- Удаление эмодзи с сохранением их мета-признаков:
  - Количество эмодзи в base и cand объявлениях
  - Наличие одинаковых эмодзи в паре объявлений

Пример перевода брендов:

```python
# Электроника и гаджеты
'айфон': 'iphone',
'эпл': 'apple',
```

**Добавляемые признаки:**

- `price_ratio` - отношение цен
- `imgcount_ratio` - отношение количества изображений
- Длины текстовых полей и их соотношения:
  - `base_description_len`, `cand_description_len`, `descr_len_ratio`
  - `base_title_len`, `cand_title_len`, `title_len_ratio`
- Категориальные признаки:
  - `same_subcategory` - совпадение подкатегорий
  - `same_category` - совпадение категорий

#### Извлечение эмбеддингов

Для изображений:

- Используется `CLIP ViT-H-14`
- Параллельная обработка на 4 GPU (L4)

Для текста:

1. **CLIP эмбеддинги:**
   - Извлекаются из title и description
   - Аналогичная параллельная обработка

2. **BERT эмбеддинги:**
   - Модель: `cointegrated/rubert-tiny2`
   - Обрабатываются:
     - title
     - description
     - json_params

### Основная обработка данных

**Входные данные:**

- Эмбеддинги изображений (.npz)
- Текстовые эмбеддинги (.npy)
- Обработанные parquet файлы

**Вычисляемые признаки:**

1. Косинусные расстояния между:
   - Изображениями base и cand (CLIP)
   - Изображением и текстом (title/description через CLIP)
   - Текстовыми полями через BERT:
     - title cand vs base
     - description cand vs base

2. Признаки изображений:
   - Разрешения фотографий
   - PCA-редуцированные эмбеддинги (до 128 компонент)

**Выходные данные:**

- `full_processed_datax.parquet` (x=1-4 для train, 1-2 для test)
- `testx_fullprepr.parquet` для тестовых данных

### Обучение модели

**Конфигурация:**

- Модель: CatBoost
- Валидация: StratifiedGroupKFold
- Параметры:

```python
{
    'iterations': 5000,
    'learning_rate': 0.05,
    'depth': 8,
    'l2_leaf_reg': 15,
    'border_count': 254,
    'eval_metric': 'PRAUC',
    'early_stopping_rounds': 150,
    'task_type': 'GPU',
    'verbose': 100,
    'loss_function': 'CrossEntropy',
    'subsample': 0.75,
    'bootstrap_type': 'Poisson',
    'min_data_in_leaf': 10
}
```

**Особенности:**

- Контроль переобучения через early stopping
- Анализ важности признаков после обучения

## Инференс

Используется ансамбль из 5 моделей



## Возможные улучшения:

1. Замена `cointegrated/rubert-tiny2` на `FRIDA` или другой дообученный `sbert`
2. Очистка данных от выбросов
3. Стэкинг catboost с нейросетевыми подходами такими как: TabFormer, TabM

## Описание данных

**Соотношение public/private в соревновании:** 20:80

### Описание колонок

| Имя колонки               | Тип        | Описание |
|---------------------------|------------|----------|
| `base_item_id`            | str        | ID опорного объявления |
| `cand_item_id`            | str        | ID объявления-кандидата |
| `group_id`                | int        | Номер группы пользователей (только для train) |
| `action_date`             | datetime   | Дата (только для train) |
| `base_category_name`      | str        | Категория опорного объявления |
| `cand_category_name`      | str        | Категория объявления-кандидата |
| `base_subcategory_name`   | str        | Подкатегория опорного объявления |
| `cand_subcategory_name`   | str        | Подкатегория кандидата |
| `base_param1`             | str        | 1-й уровень детализации подкатегории (опорное) |
| `cand_param1`             | str        | 1-й уровень детализации подкатегории (кандидат) |
| `base_param2`             | str        | 2-й уровень детализации подкатегории (опорное) |
| `cand_param2`             | str        | 2-й уровень детализации подкатегории (кандидат) |
| `base_title`              | str        | Заголовок опорного объявления |
| `cand_title`              | str        | Заголовок кандидата |
| `base_description`        | str        | Описание опорного объявления |
| `cand_description`        | str        | Описание кандидата |
| `base_price`              | float      | Цена опорного объявления |
| `cand_price`              | float      | Цена кандидата |
| `base_json_params`        | str (json) | Атрибуты опорного объявления |
| `cand_json_params`        | str (json) | Атрибуты кандидата |
| `base_count_images`       | int        | Число фотографий (опорное) |
| `cand_count_images`       | int        | Число фотографий (кандидат) |
| `base_title_image`        | str        | ID титульной фотографии (опорное) |
| `cand_title_image`        | str        | ID титульной фотографии (кандидат) |
| `is_same_location`        | bool       | Совпадение локации (город/село) |
| `is_same_region`          | bool       | Совпадение региона |
| `is_double`               | bool       | Является ли парой дублей (только для train) |
